<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ground Rod ERP - Enhanced Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script>
    const { useState, useEffect, useContext } = React;
    const API_URL = window.location.origin + '/api';

    // Toast Context
    const ToastContext = React.createContext();

    function ToastProvider({ children }) {
      const [toasts, setToasts] = React.useState([]);

      const addToast = React.useCallback((message, type = 'info', action = null) => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type, action }]);
        if (!action) {
          setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 5000);
        }
      }, []);

      const removeToast = React.useCallback((id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, []);

      return React.createElement(ToastContext.Provider, { value: { addToast, removeToast } },
        children,
        React.createElement('div', { className: 'fixed top-4 right-4 z-50 space-y-2', style: { maxWidth: '400px' } },
          toasts.map(toast =>
            React.createElement('div', {
              key: toast.id,
              className: `${
                toast.type === 'success' ? 'bg-green-50 border-green-500 text-green-800' :
                toast.type === 'error' ? 'bg-red-50 border-red-500 text-red-800' :
                toast.type === 'warning' ? 'bg-yellow-50 border-yellow-500 text-yellow-800' :
                'bg-blue-50 border-blue-500 text-blue-800'
              } border-l-4 p-4 rounded shadow-lg flex items-start gap-3`
            },
              React.createElement('div', { className: 'flex-1' },
                React.createElement('p', { className: 'font-semibold text-sm' }, toast.message),
                toast.action && React.createElement('button', {
                  className: 'mt-2 text-xs font-bold underline hover:no-underline',
                  onClick: () => { toast.action.onClick(); removeToast(toast.id); }
                }, toast.action.label)
              ),
              React.createElement('button', {
                onClick: () => removeToast(toast.id),
                className: 'text-xl font-bold opacity-50 hover:opacity-100'
              }, '×')
            )
          )
        )
      );
    }

    // Main App
    function App() {
      const toast = useContext(ToastContext);
      const [inventory, setInventory] = useState([]);
      const [loading, setLoading] = useState(true);
      const [auditLog, setAuditLog] = useState([]);
      const [showAudit, setShowAudit] = useState(false);

      useEffect(() => { fetchData(); }, []);

      async function fetchData() {
        setLoading(true);
        try {
          const [invRes, auditRes] = await Promise.all([
            fetch(`${API_URL}/inventory`),
            fetch(`${API_URL}/audit-log?limit=20`)
          ]);
          setInventory(await invRes.json());
          setAuditLog(await auditRes.json());
          if (toast) toast.addToast('Data loaded successfully', 'success');
        } catch (err) {
          if (toast) toast.addToast('Failed to load data: ' + err.message, 'error');
        }
        setLoading(false);
      }

      async function testAvailabilityCheck() {
        if (inventory.length === 0) {
          toast.addToast('No inventory data available', 'warning');
          return;
        }
        const firstProduct = inventory[0];
        const testQty = (firstProduct.available || 0) + 1000;

        try {
          const res = await fetch(`${API_URL}/inventory/check-availability`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              line_items: [{
                product_id: firstProduct.product_id,
                quantity: testQty
              }]
            })
          });
          const result = await res.json();

          if (result.available) {
            toast.addToast(`✓ Available: ${testQty} units of ${firstProduct.product_id}`, 'success');
          } else {
            toast.addToast(`⚠️ Insufficient: ${result.warnings[0]}`, 'warning');
          }
        } catch (err) {
          toast.addToast('Availability check failed', 'error');
        }
      }

      async function testUndo() {
        toast.addToast('Simulated deletion - would show undo button here', 'info', {
          label: 'UNDO',
          onClick: () => {
            toast.addToast('Undo clicked! Record would be restored', 'success');
          }
        });
      }

      if (loading) {
        return React.createElement('div', { className: 'flex items-center justify-center min-h-screen' },
          React.createElement('div', { className: 'text-center' },
            React.createElement('div', { className: 'animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto' }),
            React.createElement('p', { className: 'mt-4 text-lg font-semibold text-gray-700' }, 'Loading Enhanced ERP...')
          )
        );
      }

      return React.createElement('div', { className: 'min-h-screen' },
        // Header
        React.createElement('header', { className: 'bg-gradient-to-r from-blue-600 to-indigo-700 shadow-lg' },
          React.createElement('div', { className: 'max-w-7xl mx-auto px-6 py-6' },
            React.createElement('h1', { className: 'text-3xl font-bold text-white' }, '🚀 Ground Rod ERP - Enhanced'),
            React.createElement('p', { className: 'text-blue-100 text-sm mt-1' }, 'With Inventory Commitment, Undo, Audit Trail & More')
          )
        ),

        // Action Buttons
        React.createElement('div', { className: 'max-w-7xl mx-auto px-6 py-4 flex gap-3 flex-wrap' },
          React.createElement('button', {
            onClick: fetchData,
            className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold shadow'
          }, '🔄 Refresh Data'),
          React.createElement('button', {
            onClick: testAvailabilityCheck,
            className: 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold shadow'
          }, '✓ Test Availability Check'),
          React.createElement('button', {
            onClick: testUndo,
            className: 'px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold shadow'
          }, '↩️ Test Undo'),
          React.createElement('button', {
            onClick: () => setShowAudit(!showAudit),
            className: 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold shadow'
          }, showAudit ? '📊 Hide Audit Log' : '📋 Show Audit Log')
        ),

        // Main Content
        React.createElement('main', { className: 'max-w-7xl mx-auto px-6 py-6' },
          // Inventory Table
          React.createElement('div', { className: 'bg-white rounded-xl shadow-lg p-6 mb-6' },
            React.createElement('h2', { className: 'text-2xl font-bold mb-4 text-gray-800' }, '📦 Enhanced Inventory View'),
            React.createElement('div', { className: 'overflow-x-auto' },
              React.createElement('table', { className: 'min-w-full divide-y divide-gray-300' },
                React.createElement('thead', { className: 'bg-gray-100' },
                  React.createElement('tr', null,
                    React.createElement('th', { className: 'px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase' }, 'Product'),
                    React.createElement('th', { className: 'px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase' }, 'Plated'),
                    React.createElement('th', { className: 'px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase' }, 'Machined'),
                    React.createElement('th', { className: 'px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase' }, 'QC'),
                    React.createElement('th', { className: 'px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase' }, 'Stamped'),
                    React.createElement('th', { className: 'px-4 py-3 text-center text-xs font-bold text-blue-700 uppercase bg-blue-50' }, 'Packed'),
                    React.createElement('th', { className: 'px-4 py-3 text-center text-xs font-bold text-orange-700 uppercase bg-orange-50' }, '⚠️ Committed'),
                    React.createElement('th', { className: 'px-4 py-3 text-center text-xs font-bold text-green-700 uppercase bg-green-50' }, '✓ Available')
                  )
                ),
                React.createElement('tbody', { className: 'bg-white divide-y divide-gray-200' },
                  inventory.map((item, idx) => {
                    const committed = item.committed || 0;
                    const available = item.available || 0;
                    const isLow = available < committed * 0.3 && committed > 0;

                    return React.createElement('tr', {
                      key: item.product_id,
                      className: idx % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100'
                    },
                      React.createElement('td', { className: 'px-4 py-3 text-sm font-bold' },
                        item.product_description || item.product_id
                      ),
                      React.createElement('td', { className: 'px-4 py-3 text-center text-sm' }, item.plated || 0),
                      React.createElement('td', { className: 'px-4 py-3 text-center text-sm' }, item.machined || 0),
                      React.createElement('td', { className: 'px-4 py-3 text-center text-sm' }, item.qc || 0),
                      React.createElement('td', { className: 'px-4 py-3 text-center text-sm' }, item.stamped || 0),
                      React.createElement('td', { className: 'px-4 py-3 text-center text-sm font-bold text-blue-700 bg-blue-50' },
                        item.packed || 0
                      ),
                      React.createElement('td', { className: 'px-4 py-3 text-center text-sm font-bold text-orange-600 bg-orange-50' },
                        committed
                      ),
                      React.createElement('td', {
                        className: `px-4 py-3 text-center text-sm font-bold ${isLow ? 'text-red-600 bg-red-50' : 'text-green-600 bg-green-50'}`
                      },
                        available,
                        isLow && ' ⚠️'
                      )
                    );
                  })
                )
              )
            ),
            React.createElement('div', { className: 'mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200' },
              React.createElement('h3', { className: 'font-bold text-sm mb-2 text-blue-900' }, '📊 Column Guide:'),
              React.createElement('ul', { className: 'text-xs space-y-1 text-blue-800' },
                React.createElement('li', null, '• ', React.createElement('strong', null, 'Packed'), ': Finished goods ready to ship'),
                React.createElement('li', null, '• ', React.createElement('strong', { className: 'text-orange-600' }, 'Committed'), ': Reserved for client purchase orders'),
                React.createElement('li', null, '• ', React.createElement('strong', { className: 'text-green-600' }, 'Available'), ': Packed - Committed (can be promised to new orders)'),
                React.createElement('li', null, '• ', React.createElement('strong', { className: 'text-red-600' }, 'Red Warning'), ': Low availability compared to commitments')
              )
            )
          ),

          // Audit Log (conditional)
          showAudit && React.createElement('div', { className: 'bg-white rounded-xl shadow-lg p-6' },
            React.createElement('h2', { className: 'text-2xl font-bold mb-4 text-gray-800' }, '📋 Recent Audit Log'),
            React.createElement('div', { className: 'space-y-2 max-h-96 overflow-y-auto' },
              auditLog.length === 0 ?
                React.createElement('p', { className: 'text-gray-500 text-sm' }, 'No audit entries yet') :
                auditLog.map(entry =>
                  React.createElement('div', {
                    key: entry.id,
                    className: 'p-3 border-l-4 border-purple-400 bg-purple-50 rounded'
                  },
                    React.createElement('div', { className: 'flex items-start gap-3' },
                      React.createElement('div', { className: 'flex-1' },
                        React.createElement('p', { className: 'text-sm font-bold' },
                          entry.action,
                          ' on ',
                          entry.table_name,
                          ' #',
                          entry.record_id
                        ),
                        React.createElement('p', { className: 'text-xs text-gray-600 mt-1' },
                          new Date(entry.timestamp).toLocaleString()
                        )
                      ),
                      React.createElement('span', {
                        className: 'px-2 py-1 text-xs font-bold rounded',
                        style: {
                          background: entry.action === 'CREATE' ? '#dcfce7' :
                                      entry.action === 'SOFT_DELETE' ? '#fee2e2' :
                                      entry.action === 'RESTORE' ? '#dbeafe' : '#f3f4f6',
                          color: entry.action === 'CREATE' ? '#166534' :
                                 entry.action === 'SOFT_DELETE' ? '#991b1b' :
                                 entry.action === 'RESTORE' ? '#1e40af' : '#374151'
                        }
                      }, entry.action)
                    )
                  )
                )
            )
          )
        ),

        // Footer
        React.createElement('footer', { className: 'max-w-7xl mx-auto px-6 py-6 text-center text-sm text-gray-600' },
          '✨ Enhanced Ground Rod ERP v2.0 | Featuring: Inventory Commitment Tracking, Soft Deletes with Undo, Complete Audit Trail, BOM-based Material Consumption'
        )
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(ToastProvider, null, React.createElement(App)));
  </script>
</body>
</html>
